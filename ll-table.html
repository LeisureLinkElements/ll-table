<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<!--<script type="application/javascript" src="../lodash/lodash.js"></script>-->

<link rel="import" href="../ll-theme/ll-theme.html">
<link rel="import" href="../ll-theme/shared-styles.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>


<!--
An element providing a solution to no problem in particular.

Example:

    <ll-table></ll-table>

@demo
-->
<dom-module id="ll-table">

    <style include="shared-styles"></style>

    <template>
        <div class="table">
            <template is="dom-if" if="{{cfg.cols}}">
                <div class="table-header">
                    <div class="table-row">
                        <template is="dom-repeat" items="[[cfg.cols]]" as="col">
                            <div class="table-cell">[[col.label]]</div>
                        </template>
                    </div>
                </div>
            </template>
            <div class="table-body">
                <template is="dom-repeat" items="[[cfg.items]]" as="item">
                    <div class="table-row" data-item-id$="[[item.id]]">
                        <template is="dom-repeat" items="[[item.cells]]" as="cell">
                            <div class="table-cell" id="[[cell.id]]">[[cell.html]]</div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </template>

</dom-module>

<script>

    var sampleData = {
        cols: [
            {
                label: 'First'
            },
            {
                label: 'Last'
            },
            {
                label: 'Phone'
            },
            {
                label: 'Action',
                cellsContent: { // Overrides content of each cell in this column.
                    element: {
                        tag: 'span',
                        innerHTML: 'yo',
                        classes: [
                            'glyphicon',
                            'glyphicon-remove-sign',
                            'remove-unit'
                        ],
                        events: [
                            {
                                in: 'click',
                                out: 'remove'
                            }
                        ]
                    }
                }
            }
        ],
        items: [
            {
                id: 'c8ske82k',
                cells: [
                    'Charles', // If content is a string, it's used as inner-html.
                    {element: {
                        tag: 'input',
                        attributes:{
                            type: 'checkbox'
                        },
                        events: [
                            {
                                in: 'change',
                                out: 'checkbox-changed'
                            }
                        ]
                    }},
                    '18087782244'
                ]
            },
            {
                id: 'skjd39ss',
                cells: [
                    'Darren',
                    'Levitt',
                    '12129998888'
                ]
            }
        ]
    };

    Polymer({

        is: 'll-table',

        properties: {
            cfg: Object,
            attached: Boolean
        },

        // Element Lifecycle

        ready: function () {
            this.fire('ll-table-ready');
            this._setConfig(sampleData);
        },

        attached: function() {
            this.fire('ll-table-attached');
            this._addDynamicContent();
        },

        // Element Behavior

        _setConfig: function(cfg) {
            this.cfg = cfg;
            var _this = this;

            // If cellsContent key is set in any of this.cfg.cols,
            // set content of each cell in those columns accordingly:
            this.cfg.cols.forEach(function(col, colNum){
                if(_.isObject(col.cellsContent)) {
                    _this.cfg.items.forEach(function(item, itemNum){
                        _this.cfg.items[itemNum].cells[colNum] = _.cloneDeep(col.cellsContent);
                    });
                }
            });

            // Assign an id to each cell, converting cells with just string content to objects.
            _this.cfg.items.forEach(function(item, itemNum){
                _this.cfg.items[itemNum].cells.forEach(function(cell, cellNum){
                    if(_.isString(cell)) {
                        _this.cfg.items[itemNum].cells[cellNum] = {html:cell};
                    }
                    _this.cfg.items[itemNum].cells[cellNum].id = _this._getCellId(item.id, cellNum);
                });
            });
        },

        _addDynamicContent: function() {
            if(_.isObject(this.cfg) && _.isArray(this.cfg.items)) {
                var
                    _this = this,
                    spec,
                    tableCell,
                    cellId,
                    polyment,
                    eventInfo;

                // Generate and attach special cell content:
                this.cfg.items.forEach(function (item, itemNum) {
                    _this.cfg.items[itemNum].cells.forEach(function (cell, cellNum) {
                        cellId = _this._getCellId(item.id, cellNum);
                        if (_.isObject(cell.element) && _.isString(cell.element.tag)) {
                            spec = cell.element;
                            tableCell = Polymer.dom(_this.root).querySelector('#' + cellId);
                            polyment = Polymer.dom(tableCell).appendChild(document.createElement(spec.tag));
                            if (_.isArray(spec.classes)) {
                                spec.classes.forEach(function (cls) {
                                    polyment.classList.add(cls); // Don't overwrite polymer classes.
                                });
                            }
                            if (_.isObject(spec.attributes)) {
                                _.forEach(spec.attributes, function (val, name) {
                                    polyment.setAttribute(name, val);
                                });
                            }
                            if (_.isString(spec.innerHTML)) {
                                Polymer.dom(polyment).innerHTML = spec.innerHTML;
                            }
                            if (_.isArray(spec.events)) {
                                spec.events.forEach(function (evtCfg) {
                                    if (_.isObject(evtCfg) && _.isString(evtCfg.in) && _.isString(evtCfg.out)) {
                                        polyment.addEventListener(evtCfg.in, function (evt) {
                                            eventInfo = {
                                                itemId: item.id,
                                                config: _.cloneDeep(evtCfg),
                                                targetAttributes: _this._getEventElementAttributes(evt)
                                            };
                                            _this._handleCellEvent(eventInfo);
                                        });
                                    }
                                });
                            }
                        }
                    });
                });
            }
        },

        _handleCellEvent: function(eventInfo) {
            console.log(eventInfo);
            this.fire(eventInfo.config.out, eventInfo);
        },

        _getCellId: function(itemId, cellNum){
            return 'itm-'+itemId+'-c'+cellNum;
        },

        /**
         * Return object with useful information about an event's target
         *
         * @param   {object}  evt
         * @returns {object}
         */
        _getEventElementAttributes: function(evt) {
            evt = evt || window.event;
            if(!_.isObject(evt)) return attr;
            var elem = evt.target || evt.srcElement;
            var attr = {};
            attrNodeMap = Array.prototype.slice.call(elem.attributes);
            attrNodeMap.forEach(function(node){
                attr[node.name] = node.value;
            });
            attr.checked = elem.checked;
            return attr;
        }

    });
</script>
