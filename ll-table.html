<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<!--<script type="application/javascript" src="../lodash/lodash.js"></script>-->

<link rel="import" href="../ll-theme/ll-theme.html">
<link rel="import" href="../ll-theme/shared-styles.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>


<!--
An element providing a solution to no problem in particular.

Example:

    <ll-table></ll-table>

@demo
-->
<dom-module id="ll-table">

    <style include="shared-styles"></style>

    <template>
        <div class="table">
            <template is="dom-if" if="{{cfg.cols}}">
                <div class="table-header">
                    <div class="table-row">
                        <template is="dom-repeat" items="[[cfg.colVals]]" as="col">
                            <div class="table-cell">[[col.label]]</div>
                        </template>
                    </div>
                </div>
            </template>
            <div class="table-body">
                <template is="dom-repeat" items="[[cfg.items]]" as="item">
                    <div class="table-row" data-item-id$="[[item.id]]">
                        <template is="dom-repeat" items="[[item.cellVals]]" as="cell">
                            <div class="table-cell" id="[[cell.id]]">[[cell.html]]</div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </template>

</dom-module>

<script>

    var sampleData = {
        cols: {
            assoc: {
                label: 'Assoc',
                content: {
                    element: {
                        tag: 'input',
                        attributes: {
                            type: 'checkbox'
                        },
                        collect: { // Describes how a list of item ids is generated from these elements
                            attribute: 'checked', // From attributes generated by this._getElementAttributes
                            value: true
                        }
                    }
                }
            },
            first: {
                label: 'First'
            },
            last: {
                label: 'Last'
            },
            phone: {
                label: 'Phone'
            },
            action: {
                label: 'Action',
                content: { // Overrides content of each cell in this column.
                    element: {
                        tag: 'span',
                        innerHTML: 'DEL',
                        classes: [
                            'glyphicon',
                            'glyphicon-remove-sign',
                            'remove-unit'
                        ],
                        events: [
                            {
                                in: 'click',
                                out: 'remove'
                            }
                        ]
                    }
                }
            }
        },
        items: [
            {
                id: 'c8ske82k',
                cells: {
                    assoc: true,
                    first: 'Charles',
                    last: 'Koehl',
                    phone: '18087782244'
                }
            },
            {
                id: 'jkwuu833',
                cells: {
                    assoc: false,
                    first: 'Gordon',
                    last: 'Bolster',
                    phone: '12778737630'
                }
            },
            {
                id: 'skjd39ss',
                cells: {
                    assoc: true,
                    first: 'Darren',
                    last: 'Levitt',
                    phone: '12129998888'
                }
            }
        ]
    };

    Polymer({

        is: 'll-table',

        properties: {
            cfg: Object,
            attached: Boolean
        },

        // Element Lifecycle

        ready: function () {
            this.fire('ll-table-ready');
            this._setConfig(sampleData);
        },

        attached: function() {
            this.fire('ll-table-attached');
            this._addDynamicContent();

            // console.log(this._getItemIds('assoc'));
        },

        // Element Behavior

        _setConfig: function(cfg) {
            this.cfg = cfg;
            var _this = this;
            var cellContent;

            // If content key is set in any column config,
            // copy the content config to each cell config in the column.
            _.forEach(this.cfg.cols, function (col, colName) {
                if (_.isObject(col.content)) {
                    _this.cfg.items.forEach(function (item, itemNum) {
                        // If the cell's config already has a value for this column,
                        // and there is a collect attribute set for an element config in the column,
                        // set that attribute with that value in the cell's attributes config:
                        cellContent = _.cloneDeep(col.content);
                        if(!_.isUndefined(item.cells[colName]) && _.isObject(cellContent.element.collect)) {
                            cellContent.element.attributes = _.assign({},cellContent.element.attributes);
                            cellContent.element.attributes[cellContent.element.collect.attribute] = item.cells[colName];
                        }
                        _this.cfg.items[itemNum].cells[colName] = cellContent;
                    });
                }
            });

            // Assign an id to each cell, converting cells with just string content to objects:
            this.cfg.items.forEach(function (item, itemNum) {
                _.forEach(item.cells, function (cell, colName) {
                    if (_.isString(cell)) {
                        _this.cfg.items[itemNum].cells[colName] = {html: cell};
                    }
                    _this.cfg.items[itemNum].cells[colName].id = _this._getCellId(item.id, colName);
                });
                _this.cfg.items[itemNum].cellVals = _.values(_this.cfg.items[itemNum].cells);
            });

            // Set cfg.colVals and cfg.cellVals for template to render:
            this.cfg.colVals = _.values(this.cfg.cols);
        },

        _addDynamicContent: function() {

            if(_.isObject(this.cfg) && _.isArray(this.cfg.items)) {
                var
                    _this = this,
                    spec,
                    tableCell,
                    cellId,
                    polyment,
                    eventInfo;

                this.cfg.items.forEach(function (item, itemNum) {
                    _.forEach(item.cells, function(cell, colName){
                        cellId = _this._getCellId(item.id, colName);
                        if (_.isObject(cell.element) && _.isString(cell.element.tag)) {
                            spec = cell.element;
                            tableCell = Polymer.dom(_this.root).querySelector('#' + cellId);
                            polyment = Polymer.dom(tableCell).appendChild(document.createElement(spec.tag));
                            if (_.isArray(spec.classes)) {
                                spec.classes.forEach(function (cls) {
                                    polyment.classList.add(cls); // Don't overwrite polymer classes.
                                });
                            }
                            if (_.isObject(spec.attributes)) {
                                _.forEach(spec.attributes, function (val, name) {
                                    if(name == 'checked') {
                                        if(val) {
                                            polyment.checked = 'checked';
                                        }
                                    } else {
                                        polyment.setAttribute(name, val);
                                    }
                                });
                            }
                            if (_.isString(spec.innerHTML)) {
                                Polymer.dom(polyment).innerHTML = spec.innerHTML;
                            }
                            if (_.isArray(spec.events)) {
                                spec.events.forEach(function (evtCfg) {
                                    if (_.isObject(evtCfg) && _.isString(evtCfg.in) && _.isString(evtCfg.out)) {
                                        polyment.addEventListener(evtCfg.in, function (evt) {
                                            eventInfo = {
                                                itemId: item.id,
                                                config: _.cloneDeep(evtCfg),
                                                targetAttributes: _this._getEventElementAttributes(evt)
                                            };
                                            _this._handleCellEvent(eventInfo);
                                        });
                                    }
                                });
                            }
                        }
                    });
                });
            }

        },

        _handleCellEvent: function(eventInfo) {
            this.fire(eventInfo.config.out, eventInfo);
            console.log('Fired "'+eventInfo.config.out+'" with ',eventInfo);
        },

        _getCellId: function(itemId, colName){
            return 'itm-'+itemId+'-c-'+colName;
        },

        /**
         * Return object with useful information about an event's target
         *
         * @param   {object}  evt
         * @returns {object}
         */
        _getEventElementAttributes: function(evt) {
            evt = evt || window.event;
            if(!_.isObject(evt)) return {};
            var elem = evt.target || evt.srcElement;
            return this._getElementAttributes(elem);
        },

        _getElementAttributes: function(elem) {
            var attr = {};
            if(!_.isObject(elem)) return attr;
            attrNodeMap = Array.prototype.slice.call(elem.attributes);
            attrNodeMap.forEach(function(node){
                attr[node.name] = node.value;
            });
            attr.checked = elem.checked;
            return attr;
        },

        /**
         * Return array of item id strings based on the 'collect' configuration of a column.
         * @param {string} column
         * @return {array)
         */
        _getItemIds: function(column) {

        }

    });
</script>
